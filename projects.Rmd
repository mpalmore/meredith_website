---
title: "Projects"
description: |
  My portfolio of data science projects
output:
  distill::distill_article:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = FALSE)
```


## Behavioral Risk Factors of Excessive Daytime Sleepiness in NHANES 2017-18

### Background

Insufficient sleep duration and quality is associated with both morbidity and mortality from cardiometabolic disorders and affects neurobehavioral functioning (Gangwesh at al., 2006; Hall et al., 2008). 

The 20th century has seen a downward trend in sleep duration and quality (Bixler, 2009). 

Studies have identified health behaviors and personal characteristics that contribute to shortened sleep duration, such as age, race, obesity, low physical activity, heavy alcohol use, high caffeine consumption, smoking (Bixler, 2009; Phillips, 1995; Temple et al., 2017; Schoenborn & Adams, 2019; Stein & Friedmann, 2005; Kredlow, 2015). 

Few research studies have sought to identify whether these relationships hold when the outcome is sleep quality rather than duration. 

Sleep quality may be different from sleep duration. The sleep cycle is complex and sleep duration is not always indicative of high-quality sleep. In addition, sufficient sleep duration may also vary depending on the individual (Bin, 2016).

Understanding factors associated with poor sleep quality could provide insight to actionable avenues for intervention and ultimately impact  quality of life, and even morbidity and mortality. 

### Study Design

Data were obtained from National Health and Nutritional Examination Survey (NHANES) 2017-2018, a cross-sectional complex survey. Home interviews and exams were conducted on a nationally representative sample of adults and children in the United States. A population-based sample was derived from a complex multistage, probability sampling design. 9,254 participants were interviewed, and 8,704 were examined. Only participants aged 18 and older were included in the analysis, resulting in a study sample size of 5,856. 

### Data 

Since this is a risk factor study, all exposures were considered equally with no primary exposure of interest. Potential risk factors were derived from evidence in the literature. BMI and caffeine intake were measured in the examination stage. Alcohol use, excessive daytime sleepiness, current smoking, depression score, race and ethnicity, age, and participation in moderate to vigorous exercise were all collected at the interview stage. All risk factors except for income-to-poverty ratio, were transformed into categorical variables based on literature-informed criteria and conventions. 


Excessive daytime sleepiness was chosen as the outcome of interest. This outcome was selected over self-reported hours of sleep because it is an indicator of sleep quality, rather than sleep duration. The question asked to participants was “In the past month, how often did {you/survey participant} feel excessively or overly sleepy during the day?” Following the convention of Lal et al., participants responded as “Often” or “Almost always” were categorized as “Yes,” and other responses were categorized as “No. This study was exploratory in nature and meant to be hypothesis-generating and replicate prior associations between behavioral risk factors and sleep quality. 

### Wrangling the data

```{r}
library(here)
#Open foreign package to convert from XPT to CSV
library(foreign)
library(dplyr)
library(tidyverse)
library(here)
library(gtsummary)
```



```{r alcohol}
#read in alcohol data
ALQ <- read.xport(here("code/sleep/ALQ_J.XPT"))

#select variables of interest
myvars <- c("SEQN", "ALQ111", "ALQ121", "ALQ130")
ALQ_filt <- ALQ[myvars]

#export to excel

write.csv(ALQ_filt,file="Alcohol_NHANES_2017.csv")
```

```{r}
#read in outcome (sleep hours) data 

sleep <- read.xport(here("code/sleep/SLQ_J.XPT"))

#select variables of interest
myvars2 <- c("SEQN", "SLD012", "SLD013", "SLQ120")
SLQ_filt <- sleep[myvars2]


## dichotomize daytime sleepiness 
SLQ_filt = mutate(SLQ_filt, day_sleep = ifelse(SLQ_filt$SLQ120 == '3' | SLQ_filt$SLQ120 == '4',1,0))

write.csv(SLQ_filt,file="Sleep_NHANES_2017.csv")

```

```{r}
#read in demographic and weighting data
demog <- read.xport(here("code/sleep/DEMO_J.XPT"))

#select variables of interest
myvars3 <- c("SEQN", "RIAGENDR", "RIDAGEYR", "RIDRETH3", 
             "WTINT2YR", "WTMEC2YR", "SDMVPSU", "SDMVSTRA", "INDFMPIR")
Demo_filt <- demog[myvars3]

#export to excel

write.csv(Demo_filt,file="Demo_NHANES_2017.csv")

```

```{r}
#read in covariate (smoking) data
SMO <- read.xport(here("code/sleep/SMQRTU_J.XPT"))

#select variables of interest
myvars <- c("SEQN", "SMQ681")
SMO_filt <- SMO[myvars]

#export to excel

write.csv(SMO_filt,file="SMOKING_NHANES_2017.csv")
```

```{r}
#read in covariate (BMI) data
BMI <- read.xport(here("code/sleep/BMX_J.XPT"))

#select variables of interest
myvars <- c("SEQN", "BMXBMI")
BMI_filt <- BMI[myvars]

#export to excel

write.csv(BMI_filt,file="BMI_NHANES_2017.csv")

```

```{r}
#read in covariate (caffeine) data
Caffeine_d1 <- read.xport(here("code/sleep/DR1TOT_J.XPT"))
Caffeine_d2 <- read.xport(here("code/sleep/DR2TOT_J.XPT"))

#select variables of interest
myvars <- c("SEQN", "DR1TCAFF")
Caff_filt <- Caffeine_d1[myvars]

myvars <- c("SEQN", "DR2TCAFF")
Caff2_filt <- Caffeine_d2[myvars]

## average the two days of caffeine measurements
caffday1 <- Caff_filt

caffday2 <- Caff2_filt

caffday1 <- left_join(caffday1, caffday2, by = "SEQN")

caffday1 <- as.data.frame(caffday1)

caffday1 <- mutate(caffday1, avg_mg_caffeine=(DR1TCAFF+DR2TCAFF)/2)

write.csv(caffday1, file="Caffeine_NHANES_2017.csv")

```

```{r}
#read in covariate (Physical Activity) data
PA <- read.xport(here("code/sleep/PAQ_J.XPT"))

#select variables of interest
myvars <- c("SEQN", "PAQ605","PAQ620","PAQ650","PAQ665")
PA_filt <- PA[myvars]

#export to excel

write.csv(PA_filt,file="Activity_NHANES_2017.csv")

```


```{r}
#read in covariate (Depression) data
Depress <- read.xport(here("code/sleep/DPQ_J.XPT"))

#All variables are of interest

#export to excel

write.csv(Depress,file="Depression_NHANES_2017.csv")

```

Read the Excel files back into R to come back to later. 

```{r}
demog <- read_csv("Demo_NHANES_2017.csv", show_col_types = FALSE)

sleep <- read_csv("Sleep_NHANES_2017.csv", show_col_types = FALSE)

alc <- read_csv("Alcohol_NHANES_2017.csv", show_col_types = FALSE)

```

Some of the data are labeled as numeric values if they were missing. Referring to NHANES documentation, you can see which numbers correspond to missing data, depending on the variable. It would be a good idea to convert them into simple NAs. 

```{r}
alc$ALQ121 <- na_if(alc$ALQ121,77)
alc$ALQ121 <- na_if(alc$ALQ121,99)

alc$ALQ130 <- na_if(alc$ALQ130,777)
alc$ALQ130 <- na_if(alc$ALQ130,999)
```

```{r}
activity <- read_csv("Activity_NHANES_2017.csv", show_col_types = FALSE)

#change to missing if "Refused" or "Don't Know"
names(activity)
activity$PAQ605 <- na_if(activity$PAQ605,9)
activity$PAQ620 <- na_if(activity$PAQ620,9)


```

```{r}
bmi <- read_csv("BMI_NHANES_2017.csv", show_col_types = FALSE)

caffeine <- read_csv("Caffeine_NHANES_2017.csv", show_col_types = FALSE)

Depress <- read_csv("Depression_NHANES_2017.csv", show_col_types = FALSE)

#change to missing if "Refused" or "Don't Know"
names(Depress)

Depress$DPQ010 = Depress$DPQ010 %>% na_if(9) %>% na_if(7)

Depress$DPQ020 = Depress$DPQ020 %>% na_if(9) %>% na_if(7)

Depress$DPQ030 = Depress$DPQ030 %>% na_if(9) %>% na_if(7)

Depress$DPQ040 = Depress$DPQ040 %>% na_if(9) %>% na_if(7)

Depress$DPQ050 = Depress$DPQ050 %>% na_if(9) %>% na_if(7)

Depress$DPQ050 = Depress$DPQ050 %>% na_if(9) %>% na_if(7)

Depress$DPQ060 = Depress$DPQ060 %>% na_if(9) %>% na_if(7)

Depress$DPQ070 = Depress$DPQ070 %>% na_if(9) %>% na_if(7)

Depress$DPQ080 = Depress$DPQ080 %>% na_if(9) %>% na_if(7)

Depress$DPQ090 = Depress$DPQ090 %>% na_if(9) %>% na_if(7)

smoking <- read_csv("SMOKING_NHANES_2017.csv", show_col_types = FALSE)

```


Now we must merge all of the component files by the individuals' identifying number (SEQN). I decide to left join with demography file as the leftmost column, because I want to retain the denominator of individuals even if some the predictor and outcome variables are missing. 

```{r}
one_tmp <- left_join(demog, sleep, by="SEQN") %>%
  left_join(., alc , by="SEQN") %>%
  left_join(., activity, by="SEQN") %>%
  left_join(., bmi, by="SEQN") %>%
  left_join(., caffeine, by="SEQN") %>%
  left_join(., Depress, by="SEQN") %>%
  left_join(., smoking, by="SEQN")
```

I created a summary depression score by summing all question responses except for DPQ100 (which was more of a measure of life quality than magnitude of depression.)

```{r}
one_tmp <- mutate(one_tmp, depress_score=rowSums(select(one_tmp, starts_with("DPQ")& !ends_with("100"))))

```


#### Categorize variables based on clinically meaningful guidelines

Now I turn depression into a categorical variable

Depression is categorized (dichotomized) based on guidelines:

1. No depression: no_dep = 1 if total score <5; 0 if total score >= 5.
2. Mild depression: mild_dep = 1 if total score <10 and >4; 0 otherwise.
3. Moderate depression: mod_dep = 1 if total score >9 and <15; 0 therwise
4. Moderate to severe: mod_sev_dep = 1 if total score >14 and <20; 0 otherwise
5. Severe: sev_dep = 1 if total score >19; 0 otherwise

```{r}
one_tmp = one_tmp %>% mutate(depress_cat = cut(depress_score, breaks = c(-Inf,4.5,9.5,14.5,19.5,Inf), labels = c('nodep','mild_dep','mod_dep','mod_sev_dep','sev_dep'))
)
```

Create race and Hispanic ethnicity categories. Combined Non-Hispanic white and Non-Hispanic other and multiple races, to approximate the sampling domains.

```{r}
one_tmp = one_tmp %>% mutate(
  race1 = factor(c(3, 3, 4, 1, NA, 2, 4)[RIDRETH3],
                 labels = c('NH Black','NH Asian', 'Hispanic', 'NH White and Other')),
  # Create race and Hispanic ethnicity categories for hypertension analysis 
  raceEthCat= factor(c(4, 4, 1, 2, NA, 3, 5)[RIDRETH3],
                     labels = c('NH White', 'NH Black', 'NH Asian', 'Hispanic', 'NH Other/Multiple')),
  # Create age categories for adults aged 18 and over: ages 18-39, 40-59, 60 and over
  ageCat_18 = cut(RIDAGEYR, breaks = c(17, 39, 59, Inf),
                  labels = c('18-39','40-59','60+'))
)


```

Regular moderate or vigorous activity reported? 1 = yes; 0 = no

```{r}
one_tmp <-  mutate(one_tmp, activity=ifelse(PAQ605==1|PAQ620==1|PAQ650==1|PAQ665==1, 1, 0))

```

Recommended caffeine dose is 400 mg. Dichotomize to above and below that threshold:

```{r}
one_tmp <- mutate(one_tmp, hi_caffeine=ifelse(avg_mg_caffeine>400.0,1,0))

```

There are standards for categorizing BMI. Let's carry them out here:

```{r}
one_tmp = one_tmp %>% mutate(BMI_cat = cut(BMXBMI, breaks = c(-Inf,18.49,24.9, 29.9,Inf), labels = c('underweight','normal','overweight','obese'))
)
```

Categorize alcohol use

Above 2 drinks a day for men or above 1 drink a day for women are considered 
in excess of "moderate drinking".
<https://www.niaaa.nih.gov/alcohol-health/overview-alcohol-consumption/moderate-binge-drinking>

Must account for those who responded that they were non-drinkers. Re-code alcohol consumption accounting for those who don't drink to correct missingness

```{r}
one_tmp <-  mutate(one_tmp, 
                   heavy_drink = ifelse((ALQ130>2 & RIAGENDR == 1) 
                                        | (ALQ130>1 & RIAGENDR == 2),1, 0))
one_tmp = one_tmp %>% mutate(heavy_drink2 = ifelse(ALQ111==2 | ALQ121==0, 0, heavy_drink))

```

Remove the columns that are artifcats of the conversion to .csv files. 

Filter the population to ages 18 and above 
```{r}

one_tmp = one_tmp %>% select(!starts_with("...1"))
colnames(one_tmp)
# Looks a lot better. 

unweighted_data <- filter(one_tmp, RIDAGEYR >=18)
```

### Correcting for missingness

How many are missing a the conventional 10% cutoff?

```{r}
missing <- colSums(is.na(unweighted_data))# Number of missing per variable
length(unweighted_data$SEQN)

missing <- missing/5856

missing

```

Missingness: No individuals were missing the outcome. Missingness was below 15% for all covariates except for high caffeine intake, which was missing at a rate of 26%.


The data looks better now. Re-write full dataset to csv:

```{r}
write.csv(one_tmp, "fulldata_2017_NHANES.csv")
```



Now that we have cleaned the NHANES data to our liking, it is time to conduct the analysis. 

Let's load the packages that we will need. Must load the tidyverse last because both the dplyr package from the tidyverse and the MASS package have a select() function and the one loaded last is the one that will be used.

```{r}
if(!require(car)){   # for added variable plots, VIF
    install.packages("car")
    library(car)
}
if(!require(sandwich)){   # for robust linear regression
    install.packages("sandwich")
    library(sandwich)
}
if(!require(GGally)){   # for fancier scatterplot matrices
    install.packages("GGally")
    library(GGally)
}
  
if(!require(broom)){   # for tidy model output using tidy() function
    install.packages("broom")
    library(broom)
}  
 
if(!require(lmtest)){   # coefficient test for robust variance
    install.packages("lmtest")
    library(lmtest)
} 

if(!require(tidyverse)){   # general functions for working with data
    install.packages("tidyverse")
    library(tidyverse)
} 

if(!require(survey)){   # general functions for working with data
    install.packages("survey")
    library(survey)
} 

```

Subset the dataset to individuals 18 and older, because that is the population we would like to make inferences to. 

```{r}

data <- one_tmp
data <- mutate(data,inAnalysis=(RIDAGEYR >=18))

# explore data 
glimpse(data)
names(data)
```

Now, we would like to specify the categorical data as either nominal or ordinal data for our models. 
BMI categories, race, and age groups should be considered separately as nominal categories. 
Depression questionnaire scores have a natural ordered relationship, so we will specify the depression variable as an ordinal variable. 

We must also set a reference group for the generalized linear models to improve our interpretations. 

```{r}
data$BMI_cat <- factor(data$BMI_cat, ordered = FALSE )
data$raceEthCat <- factor(data$raceEthCat, ordered = FALSE )
data$ageCat_18 <- factor(data$ageCat_18, ordered = FALSE)
data$depress_cat <- ordered(data$depress_cat, levels = c("nodep","mild_dep","mod_dep","mod_sev_dep","sev_dep"))

#Set reference groups for statistical models
data <- within(data, raceEthCat <- relevel(raceEthCat, ref = "NH White"))
data <- within(data, BMI_cat <- relevel(BMI_cat, ref = "normal"))
data <- within(data, ageCat_18 <- relevel(ageCat_18, ref = "18-39"))

```

#### Table 1
```{r}
library(tableone)
listVars <- c("RIAGENDR", "ageCat_18", "INDFMPIR", "SMQ681", "raceEthCat", "activity", "hi_caffeine", "BMI_cat", "heavy_drink2", "depress_cat")
catVars <- c("RIAGENDR", "ageCat_18", "SMQ681", "raceEthCat", "activity", "hi_caffeine", "BMI_cat", "heavy_drink2", "depress_cat")

table1 <- CreateTableOne(vars = listVars, data = unweighted_data, factorVars = catVars, strata=c("day_sleep"))
dotable1 <- print(table1, quote=TRUE, noSpaces=TRUE)

```

#### Figure 1: Caffeine intake and Daytime Sleepiness

```{r}
#png("Barplot Caffeine.png")
counts <- table(unweighted_data$hi_caffeine, unweighted_data$day_sleep)
barplot(counts, main="High Caffeine Intake by Daytime Sleepiness",
        ylab = "Number of Individuals",
        xlab="Daytime Sleepiness", col=c("darkblue","purple"),
        legend = c("Low Caffeine Intake", "High Caffeine Intake"), beside=TRUE)
#dev.off()
```

#### Figure 2: Dperession and Daytime Sleepiness

```{r}
#png("Barplot Depression.png")
counts <- table(unweighted_data$depress_cat, unweighted_data$day_sleep)
barplot(counts, main="Depression Category Distribution by Daytime Sleepiness",
        ylab = "Number of Individuals",
        xlab="Daytime Sleepiness", col=c("darkblue","purple","orange","yellow","lightblue"),
        legend = c("No Depression", "Mild Depression", "Moderate Depression", "Moderate/severe Depression", "Severe Depression"), beside=TRUE)
#dev.off()
```


### Statistical Methods 

Let's develop a pipeline for our statistical analyses!

* Part a:  Scatterplot matrices
* Part b:  Fit weighted and unweighted SLRs
* Part c:  Fit initial weighted and unweighted MLR model using all predictors
* Part d:  Best subset model selection and human-selected model
* Part e.  Compare model AICs and goodness of fit
* Part f:  Check model:  Analysis of Residuals
* Part f-1:  Plot person residuals -vs- predicted values
* Part f-2:  Boxplot and list outlier studentized residuals
* Part g: Check model:  leverage boxplots
* Part h: Check model:  influence
* Part h-1:  Make boxplot and list outliers for influence
* Part h-2:  Leverage -vs- residual squared (L-R) plot
* Part i: Sensitivity analysis:  Re-fit without influential points
* Part j: Check for multi-collinearity using variance inflation factors

###########################################################################

#### Part a: Scatterplot matrices

Using the ggpairs() function, which is nice for getting a quick scatterplot matrix plot

We must first created an unweighted dataset of those >=18. 

Then we will make two separate scatterplot matrices. We must do this because if we make one matrix, it will be way too large and difficult to read. First we will make one of personal characteristics, and second, we will make one of lifestyle/behavioral characteristics. 

```{r}
unweighted_data <- filter(data, RIDAGEYR >=18)

#pdf("scatterplot_matrices_person.pdf")
unweighted_data %>%
  dplyr::select(RIAGENDR, RIDAGEYR, INDFMPIR,depress_score,BMXBMI) %>%
  pairs(upper.panel=NULL)
#dev.off()

#pdf("scatterplot_matrices_behavior.pdf")
unweighted_data %>%
  dplyr::select(avg_mg_caffeine,SMQ681,ALQ130,activity) %>%
  pairs(upper.panel=NULL)
#dev.off()

```

There is no clear correlation between X's.

#### Part b:  Fit weighted and unweighted SLRs

 Create a survey weight object

```{r}
NHANES_all <- svydesign(data=data, id=~SDMVPSU, strata=~SDMVSTRA, weights=~WTINT2YR, nest=TRUE)
NHANES_all_MEC <- svydesign(data=data, id=~SDMVPSU, strata=~SDMVSTRA, weights=~WTMEC2YR, nest=TRUE)

NHANES <- subset(NHANES_all, inAnalysis==1)
NHANES_MEC <- subset(NHANES_all_MEC, inAnalysis==1)

```


Fit the weighted univariate models and store the results. We are calculating the change in log prevalence odds of daytime sleepiness, our outcome, among levels of the "exposures". Our exposures of interest are sex, age groups, income, smoking, race/ethnicity, any activity, high caffeine intake, BMI categories, heavy drinking, and ordinal depression scores. Log-binomial regression is used to estimate crude associations.

```{r echo=FALSE}

model_1w <- svyglm(day_sleep~RIAGENDR, design=NHANES, family=quasibinomial(link="log"))
model_2w <- svyglm(day_sleep~ageCat_18, design=NHANES, family=quasibinomial(link="log"))
model_3w <- svyglm(day_sleep~INDFMPIR, design=NHANES, family=quasibinomial(link="log"))
model_4w <- svyglm(day_sleep~SMQ681, design=NHANES, family=quasibinomial(link="log"))
model_5w <- svyglm(day_sleep~raceEthCat, design=NHANES, family=quasibinomial(link="log"))
model_6w <- svyglm(day_sleep~activity, design=NHANES, family=quasibinomial(link="log"))
model_7w <- svyglm(day_sleep~hi_caffeine, design=NHANES_MEC, family=quasibinomial(link="log"))
model_8w <- svyglm(day_sleep~BMI_cat, design=NHANES_MEC, family=quasibinomial(link="log"))
model_9w <- svyglm(day_sleep~heavy_drink2, design=NHANES, family=quasibinomial(link="log"))
model_10w <- svyglm(day_sleep~depress_cat, design=NHANES, family=quasibinomial(link="log"))

```

```{r eval=FALSE, include=FALSE}
#exponentiated coefficients

exp(model_1w$coefficients)
exp(model_2w$coefficients)
exp(model_3w$coefficients)
exp(model_4w$coefficients)
exp(model_5w$coefficients)
exp(model_6w$coefficients)
exp(model_7w$coefficients)
exp(model_8w$coefficients)
exp(model_9w$coefficients)
exp(model_10w$coefficients)

# p-values
summary(model_1w)
summary(model_2w)
summary(model_3w)
summary(model_4w)
summary(model_5w)
summary(model_6w)
summary(model_7w)
summary(model_8w)
summary(model_9w)
summary(model_10w)

#confidence intervals
exp(confint(model_1w))
exp(confint(model_2w))
exp(confint(model_3w))
exp(confint(model_4w))
exp(confint(model_5w))
exp(confint(model_6w))
exp(confint(model_7w))
exp(confint(model_8w))
exp(confint(model_9w))
exp(confint(model_10w))
```


Let's also look at the univariate associations in unweighted models. We expect a change in the standard errors. It will not be as representative of the US population. 

```{r, echo=FALSE}

# fit the unweighted models and store the results

model_1u <- glm(day_sleep~RIAGENDR, family=binomial(link="log"), data = unweighted_data)
model_2u <- glm(day_sleep~ageCat_18, family=binomial(link="log"), data = unweighted_data)
model_3u <- glm(day_sleep~INDFMPIR, family=binomial(link="log"), data = unweighted_data)
model_4u <- glm(day_sleep~SMQ681, family=binomial(link="log"), data = unweighted_data)
model_5u <- glm(day_sleep~raceEthCat, family=binomial(link="log"), data = unweighted_data)
model_6u <- glm(day_sleep~activity, family=binomial(link="log"), data = unweighted_data)
model_7u <- glm(day_sleep~hi_caffeine, family=binomial(link="log"), data = unweighted_data)
model_8u <- glm(day_sleep~BMI_cat, family=binomial(link="log"), data = unweighted_data)
model_9u <- glm(day_sleep~heavy_drink2, family=binomial(link="log"), data = unweighted_data)
model_10u <- glm(day_sleep~depress_cat, family=binomial(link="log"), data = unweighted_data)

```

```{r include=FALSE}

#exponentiated coefficients

exp(model_1u$coefficients)
exp(model_2u$coefficients)
exp(model_3u$coefficients)
exp(model_4u$coefficients)
exp(model_5u$coefficients)
exp(model_6u$coefficients)
exp(model_7u$coefficients)
exp(model_8u$coefficients)
exp(model_9u$coefficients)
exp(model_10u$coefficients)

# p-values
summary(model_1u)
summary(model_2u)
summary(model_3u)
summary(model_4u)
summary(model_5u)
summary(model_6u)
summary(model_7u)
summary(model_8u)
summary(model_9u)
summary(model_10u)
```


#### Part c: Fit initial MLR using all predictors

Multivariable Poisson regression with robust standard errors will be used to estimate adjusted prevalence ratios. Unweighted multivariable candidate models were selected in 4 ways:

1. Including all predictors
2. Best subset selection
3. a-priori selection based on literature and common knowledge
4. Combination of a priori and best-subset

First, lets run the models with every predictor

 Note: logit models failed to converge. Use poisson model. From the svy package:
 svyglm always returns 'model-robust' standard errors; the Horvitz-Thompson-type 
 standard errors used everywhere in the survey package are a generalisation of 
 the model-robust 'sandwich' estimators. In particular, a quasi-Poisson svyglm 
 will return correct standard errors for relative risk regression models.


**Using Exam weights (recommended):**
 
```{r}
MLR_1 <- svyglm(day_sleep~RIAGENDR+ INDFMPIR + SMQ681 + ageCat_18+
                           + raceEthCat + activity + hi_caffeine + BMI_cat + 
                             heavy_drink2 + depress_cat, design=NHANES_MEC, 
                           family=quasipoisson(link="log"))

summary(MLR_1, df.resid = degf(NHANES_MEC))

#linearHypothesis(MLR_1, "ageCat_1818-39=ageCat_1840-59")
#linearHypothesis(MLR_1, "ageCat_1818-39=ageCat_1860+")

exp(MLR_1$coefficients)
```
 

**Using Interview weights**

```{r}
MLR_2 <- svyglm(day_sleep~RIAGENDR + ageCat_18 + INDFMPIR + SMQ681 
                + raceEthCat + activity + hi_caffeine + BMI_cat + 
                  heavy_drink2 + depress_cat, design=NHANES, 
                family=quasipoisson(link="log"))

summary(MLR_2, df.resid = degf(NHANES))

exp(MLR_2$coefficients)

```
 
**Un-weighted**
 
```{r}
MLR_3 <- glm(day_sleep~RIAGENDR + ageCat_18 + INDFMPIR + SMQ681 
             + raceEthCat + activity + hi_caffeine + BMI_cat + 
               heavy_drink2 + depress_cat, family=poisson(link="log"), data = unweighted_data)

summary(MLR_3)
coeftest(MLR_3, vcov = sandwich)

exp(MLR_3$coefficients)

```
 

 
The unweighted regression results are qualitatively the same as the weighted regression results. I I also am not able to easily perform regression diagnostics with the survey weighted glm, so I will proceed with the unweighted model 3 for simplicity. This is reasonable, since we are trying to observe risk factors to daytime sleepiness in our sample and are not trying to predict prevalence of these risk factors in the United States population. 


#### Part d: selection of best model using AIC and a priori

Next, we will run our best subset AI model to select the most parsimonious predictors

We will also attempt best-subset model selection to ensure that we are not missing any potentially relevant variables in our a-priori models. 

```{r}
analytic_data <- na.omit(unweighted_data)

# can do this all at once with step function when done by AIC
model_0 <- glm(day_sleep ~ 1, data = analytic_data, family = poisson(link = "log"))    # start with null model
mod_final <- step(model_0, scope = ~ . + RIAGENDR + ageCat_18 + INDFMPIR-1 + SMQ681 
                  + activity + hi_caffeine + BMI_cat + raceEthCat +
                    heavy_drink2 + depress_cat, family=poisson(link="log"), 
                  data = analytic_data, direction = "forward", na.rm = TRUE)   # add terms one at a time using AIC

coeftest(mod_final, vcov. = sandwich)

summary(mod_final)

exp(mod_final$coefficients)

```

We see the  final model has depression category, race, and age as the most parsimonious predictors explaining daytime sleepiness in our sample

Now, let's look at our a-priori models


**Model using behavioral risk factors only (a priori)**

```{r}

mod_behav <- glm(day_sleep~SMQ681 + activity + hi_caffeine + heavy_drink2, 
                     family=poisson(link="log"), data = unweighted_data)

#robust variance
coeftest(mod_behav, vcov = sandwich)

#coefficents
exp(mod_behav$coefficients)

```


**Model combining a priori and best-subset selection**

```{r}
mod_final_behav <- glm(day_sleep~depress_cat + ageCat_18 + SMQ681 + activity + raceEthCat +
                          hi_caffeine + heavy_drink2, family=poisson(link="log"), data = unweighted_data)

summary(mod_final_behav)

coeftest(mod_final_behav, vcov = sandwich)
```

#### Part e: AIC and Goodness of Fit (pearson's chi-sq)

Calculate deviance residuals since the models are poisson, not linear. 

```{r}
with(mod_final_behav, cbind(res.deviance = deviance, df = df.residual, p = pchisq(deviance, df.residual, lower.tail=FALSE)))

with(mod_final, cbind(res.deviance = deviance, df = df.residual,
                            p = pchisq(deviance, df.residual, lower.tail=FALSE)))

with(MLR_3, cbind(res.deviance = deviance, df = df.residual,
                            p = pchisq(deviance, df.residual, lower.tail=FALSE)))

```

Calculate the fit of the models using Aikake's Information Criterion, a measure of parsimony and model goodness of fit:

```{r}
AIC(mod_final)

AIC(MLR_3)

AIC(mod_final_behav)
```


There was some lost data in the best subset regression since there was some missingness. Therefore, the AIC is not as great as it seems when run on the full dataset. Let's try the best subset model on the full data:

```{r}

Mod_bestsub <- glm(day_sleep ~ ageCat_18 + depress_cat + raceEthCat, data = unweighted_data, family = poisson(link = "log"))

AIC(Mod_bestsub)

```

We see in the analyses above that the model with the best fit is the model including all covariates. However, since the epidemiologic question is seeking to understand which the behavioral risk factors may be most impactful on daytime sleepiness, we will proceed with the model including all behavioral covariates (ever smoking, moderate/high physical activity, race, high caffeine consumption, and heavy drinking) + the covariates identified in the best-subset model (age and depression)

#### Part f: Model diagnostics

Model diagnostics that we will perform include residual versus fitted plots, Q-Q plots, leverage boxplots, residual boxplots and influential point boxplots. 


###### Part f-1:  Plot studentized residual -vs- predicted values


 Calculate predicted values and residuals in **weighted data - model w/ all covariates**
 
```{r}
fit_dat <- as.data.frame(MLR_1$fitted.values)
pearson_res_w <- residuals(MLR_1, type = "pearson")
fit_dat <- cbind(fit_dat, pearson_res_w)



fit_dat %>%
  ggplot(aes(x = MLR_1$fitted.values, y = pearson_res_w)) + 
  geom_point() + 
  geom_hline(yintercept = c(-2, 0, 2), col="red") + 
  geom_smooth(method = lm) +
  labs(x = "Fitted values", y = "Pearson Residuals", title = "Residuals vs. Fitted values")

ggsave("pearson_resids_weighted.png", width = 6, height = 4, units = "in")

```

 Calculate predicted values and residuals in **unweighted data - model w/ all covariates**
 
```{r}
fit_dat2 <- as.data.frame(MLR_3$fitted.values)
pearson_res <- residuals(MLR_3, type = "pearson")
fit_dat2 <- cbind(fit_dat2, pearson_res)

fit_dat2 %>%
  ggplot(aes(x = MLR_3$fitted.values, y = pearson_res)) + 
  geom_point() + 
  geom_hline(yintercept = c(-2, 0, 2), col="red") + 
  geom_smooth(method = lm) +
  labs(x = "Fitted values", y = "Pearson Residuals", title = "Residuals vs. Fitted values")
ggsave("pearson_resids_unweighted.png", width = 6, height = 4, units = "in")
```

The loess line is flat, which means there is no trend in the residuals. 
Equal variances/ linear assumption is met.


Calculate predicted values and residuals in **unweighted final model**

```{r}


fit_dat_fin <- as.data.frame(mod_final_behav$fitted.values)
pearson_res_fin <- residuals(mod_final_behav, type = "pearson")
fit_dat_fin <- cbind(fit_dat_fin, pearson_res_fin)

fit_dat_fin %>%
  ggplot(aes(x = mod_final_behav$fitted.values, y = pearson_res_fin)) + 
  geom_point() + 
  geom_hline(yintercept = c(-2, 0, 2), col="red") + 
  geom_smooth(method = lm) +
  labs(x = "Fitted values", y = "Pearson Residuals", title = "Residuals vs. Fitted values")

ggsave("pearson_resids_final_behave_model.png", width = 6, height = 4, units = "in")

```

Now, let's create a Q-Q plot of deviance residuals for the final model and the model including all covariates

```{r}
fit_dat_fin_apriori <- as.data.frame(mod_final_behav$fitted.values)
deviance_res_apriori <- residuals(mod_final_behav, type = "deviance")
fit_dat_fin_apriori <- cbind(fit_dat_fin_apriori, deviance_res_apriori)

fit_dat_fin_apriori %>%
  ggplot(aes(sample = deviance_res_apriori)) +
  geom_qq() + 
  geom_qq_line() + 
  labs(title = "Q-Q plot of deviance residuals")

ggsave("Q-Q_final_behav_mod.png", width = 6, height = 4, units = "in")


fit_dat_fin_all <- as.data.frame(MLR_3$fitted.values)
deviance_res_fin <- residuals(MLR_3, type = "deviance")
fit_dat_fin_all <- cbind(fit_dat_fin_all, deviance_res_fin)

fit_dat_fin_all %>%
  ggplot(aes(sample = deviance_res_fin)) +
  geom_qq() + 
  geom_qq_line() + 
  labs(title = "Q-Q plot of deviance residuals")

ggsave("Q-Q_all_variables.png", width = 6, height = 4, units = "in")

```

Under the correct distribution of the response, we expect the points to align 
with the diagonal line. It is usual to have departures from the diagonal in 
the extremes other than in the center, even under normality. Assumption is met.


##### Part f-2 : check outliers

Identify the outliers in the **final a-priori models**:

```{r}

fit_dat_fin_apriori %>%
  ggplot() +
  geom_boxplot(aes(y = pearson_res_fin)) +
  labs(y="Pearson residuals", title="Boxplot of pearson residuals")

# Looking at the plot we can filter to see which observation is the outlier
fit_dat_fin_apriori %>% 
  filter(pearson_res_fin > 2.5)

ggsave("outlier_residuals_apriori.png", width = 6, height = 4, units = "in")

```

#### Part g : check leverage 

```{r}
fit_dat_fin_apriori <- fit_dat_fin_apriori %>%
  mutate(lev = hatvalues(mod_final_behav))

# Boxplot of leverage values
fit_dat_fin_apriori %>%
  ggplot() +
  geom_boxplot(aes(y = lev)) +
  labs(y="Leverage values", title="Boxplot of leverages")


summary(fit_dat_fin_apriori$lev)
lev_outliers <- 0.004278 + 1.5*(IQR(fit_dat_fin_apriori$lev))

list_lev_outliers <- fit_dat_fin_apriori %>% 
  filter(lev > lev_outliers)

glimpse(list_lev_outliers)
nrow(list_lev_outliers)


ggsave("Leverages_apriori.png", width = 6, height = 4, units = "in")

# There are very many leverage outliers

```

#### Part h: Check model: influence
###### Part h-1:  Make boxplot and list outliers for influence

```{r}
# Calculate DFITS influence measure -- effect ith obs on overall fit
# Add them to data set
fit_dat_fin_apriori <- fit_dat_fin_apriori %>%
  mutate(dfits = dffits(mod_final_behav))

# Boxplot of dfits values
fit_dat_fin_apriori %>%
  ggplot() +
  geom_boxplot(aes(y = dfits)) +
  labs(y="DFITS values", title="Boxplot of DFIT values")


ggsave("dfits_apriori.png", width = 6, height = 4, units = "in")

# Look at outliers
fit_dat_fin_apriori %>% 
  dplyr::select(dfits) %>%
  filter(dfits <= quantile(dfits, .25) - 1.5*IQR(dfits) | 
           dfits >= quantile(dfits, .75) + 1.5*IQR(dfits)) %>%
  arrange(dfits)
```


##### Part h-2:  Leverage -vs- residual squared (L-R) plot

```{r}
fit_dat_fin_apriori %>%
  ggplot(aes(x = pearson_res_fin^2, y = lev)) + 
  geom_point() +
  geom_hline(yintercept = mean(fit_dat_fin_apriori$lev), col="red") +
  geom_vline(xintercept = mean(fit_dat_fin_apriori$pearson_res_fin^2), col="red") +
  labs(title="Leverage-Residual Plot")

ggsave("L-R plot apriori.png", width = 6, height = 4, units = "in")
```


#### Part i: Sensitivity analysis:  Re-fit without influential points

Sensitivity analysis conducted on the 8 most influential points:

 Create new data set without influential points:
 
```{r}

unweighted_data_noip <- unweighted_data %>%
  filter(SEQN != 2876, SEQN != 5791, SEQN != 1373, SEQN != 5401, SEQN != 135,
         SEQN != 5150, SEQN != 4173, SEQN != 1345)

```

Fit the model without the influential points:

```{r}
model_final_b_no_outliers <- glm(day_sleep~depress_cat + ageCat_18 + SMQ681 + activity + 
                                   raceEthCat + hi_caffeine + heavy_drink2, family=poisson(link="log"), data = unweighted_data)

summary(model_final_b_no_outliers)

coeftest(mod_final_behav, vcov = sandwich)

exp(model_final_b_no_outliers$coefficients)
exp(mod_final_behav$coefficients)
```

#### Part j: Check variance inflation

```{r}
vif(MLR_3) #check VIF of unweighted model with all risk factors
vif(mod_final) # check VIF of best subset model
vif(mod_final_behav) # check VIF of a priori model
```

### Results 


```{r}

unweighted_data %>%
  select(day_sleep, RIAGENDR, ageCat_18, INDFMPIR, SMQ681, raceEthCat, activity, hi_caffeine, BMI_cat, heavy_drink2, depress_cat) %>%
  tbl_uvregression(
    method = glm,
    y = day_sleep,
    method.args = list(family = binomial(link="log")),
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 2)
  ) %>%
  add_global_p() %>%  # add global p-value
  add_q() %>%         # adjusts global p-values for multiple testing
  bold_p() %>%        # bold p-values under a given threshold (default 0.05)
  bold_p(t = 0.10, q = TRUE) %>% # now bold q-values under the threshold of 0.10
  modify_caption("Crude Table") %>%
  bold_labels()
```

Best subset model included race categories, age categories, and depression score categories as predictors. The final model was the model including behavioral variables selected a-priori, along with age and depression score which were identified through the AI model. This final model best suits the epidemiological question at hand: which risk factors are most important in the relationship with excessive daytime sleepiness, with a special emphasis on modifiable lifestyle factors?

 * The predictors in the final model: age categories, race categories, depression score categories, current smoking, weekly moderate to vigorous activity, high caffeine intake, and heavy alcohol use

The dataset was large, so the model is still parsimonious with many predictors. All candidate models had Pearson’s Goodness of Fit p-values equal to 1, so all fit the data very well. None of the variables showed signs of collinearity for any of the candidate models. 

#### Results from the final model:

```{r}

mod_final_behav %>% 
  tbl_regression(exponentiate = TRUE) %>%
  add_global_p() %>%  # add global p-value 
  add_q() %>%         # adjusts global p-values for multiple testing
  bold_p() %>%        # bold p-values under a given threshold (default 0.05)
  bold_p(t = 0.10, q = TRUE) %>% # now bold q-values under the threshold of 0.10
  modify_caption("Final model") %>%
  bold_labels() 

```


* Belonging to older age groups (40-59 years & 60+ years) conferred a decreased risk of excessive daytime sleepiness when compared to a referent group of 18-39 years, contrary to what is expected based on the literature
  + This may indicate that age-differential lifestyle factors confound the relationship between age and sleep quality. 
  
* There was also an association in the opposite direction of to what is expected for race categories.
  + When compared to white individuals, Hispanic, Asian, and Black individuals have a decreased risk of excessive daytime sleepiness 
    - Perhaps the relationship is confounded by social factors not accounted for in the study
    
* Associations with the most potential for intervention were mild and moderate to severe depression, caffeine intake, and obesity 
  + The direction of the association of depression score with excessive daytime sleepiness varied by severity, which may be due to low sample sizes in severity categories
  
* Some covariates previously presented as risk factors for poor sleep quality in the literature that were not replicated in this study were heavy alcohol use, current tobacco smoking, and participation in weekly moderate to vigorous physical activity


### Conclusions and future directions

Conflicting results emphasize the need for more research is needed to uncover the links between age, race, alcohol use, tobacco smoking and exercise on sleep quality

High daily caffeine consumption is a modifiable risk factor that could play a role in causing excessive sleepiness during the day. 

Based on these results and the results of previous research, it may be clinically advisable to address sleep hygiene in people with depression and obesity to prevent future morbidity and mortality. 

